<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AR: كرسي في الغرفة + تتبع جزمة (محسّن)</title>
  <meta name="description" content="تجربة واقع معزز: كرسي في الغرفة + تتبع جزمة تجريبي باستخدام MediaPipe (محسن)." />
  <style>
    :root{--bg:#0b1220;--card:#0f1724;--muted:#9aa4b2;--accent:#2dd4bf}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e6eef6;font-family:system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    header{padding:14px 18px;border-bottom:1px solid #0e1622;display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{margin:0;font-size:15px}
    .tabs{display:flex;gap:8px}
    .tab-btn{background:#121826;color:#cfe6f3;border:1px solid #1d2430;padding:8px 12px;border-radius:10px;cursor:pointer;font-size:14px}
    .tab-btn.active{background:var(--accent);color:#03221f;font-weight:700}
    main{padding:18px}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:linear-gradient(180deg,#0d1420,#0b1118);border-radius:12px;padding:14px;border:1px solid #1b2430}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button,select,input[type=range]{appearance:none;border-radius:10px;padding:8px 12px;border:1px solid #26313f;background:#111827;color:#e6eef6;cursor:pointer}
    button.primary{background:var(--accent);color:#03221f;border:none}
    .hint{color:var(--muted);font-size:13px}
    .mv-wrap{border-radius:12px;overflow:hidden;border:1px solid #19222e;margin-top:12px}
    model-viewer{width:100%;height:64vh;background:#071018;display:block}
    .camera-wrap{position:relative;width:100%;max-width:960px;margin:12px auto;border-radius:12px;overflow:hidden;border:1px solid #19222e;background:#000}
    video#cam{width:100%;height:auto;display:block;transform:scaleX(-1)} /* mirror */
    canvas#debug{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;transform:scaleX(-1)}
    img#shoeOverlay{position:absolute;left:0;top:0;display:none;pointer-events:none;transform-origin:center center;filter:drop-shadow(0 12px 24px rgba(0,0,0,.5))}
    .status{font-size:13px;color:var(--muted)}
    footer{padding:10px;text-align:center;color:#718096;border-top:1px solid #0e1622;margin-top:16px}
    .warning{color:#ffb86b}
    @media (max-width:600px){ model-viewer{height:58vh} }
  </style>

  <!-- model-viewer للكرسي -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <header>
    <h1>تجربة AR محسّنة — كرسي في الغرفة & تتبّع جزمة</h1>
    <div class="tabs">
      <button class="tab-btn active" data-tab="chair">AR كرسي</button>
      <button class="tab-btn" data-tab="shoe">تتبع جزمة</button>
    </div>
  </header>

  <main>
    <!-- AR كرسي -->
    <section id="panel-chair" class="panel active">
      <div class="card">
        <div class="row">
          <div class="status">وضع الكرسي في الغرفة — اضغط زر AR ثم حرّك الكاميرا لاختيار سطح</div>
        </div>
        <div class="mv-wrap" style="margin-top:12px">
          <model-viewer id="chairMV"
            src="https://modelviewer.dev/shared-assets/models/Chair.glb"
            ios-src="https://modelviewer.dev/shared-assets/models/Chair.usdz"
            alt="كرسي ثلاثي الأبعاد"
            ar ar-modes="webxr scene-viewer quick-look"
            camera-controls environment-image="neutral"
            poster="https://modelviewer.dev/assets/posters/shishkebab.png"
            shadow-intensity="1" style="display:block"></model-viewer>
        </div>
        <div class="controls">
          <button id="swapChair">تبديل نموذج</button>
          <div class="hint">نماذج GLB مجانية من modelviewer.dev</div>
        </div>
      </div>
    </section>

    <!-- Shoe try-on -->
    <section id="panel-shoe" class="panel">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <span class="status">تجريبي: تتبّع الجزمة باستخدام MediaPipe (المجاني)</span>
          </div>
          <div class="warning" id="secureWarn" style="display:none">ملاحظة: الوصول للكاميرا يتطلب HTTPS</div>
        </div>

        <div style="margin-top:10px" class="controls">
          <label>كاميرا:
            <select id="cameraSelect">
              <option value="environment">الخلفية (مفضل)</option>
              <option value="user">الأمامية</option>
            </select>
          </label>

          <label>دقّة:
            <select id="resSelect">
              <option value="640x480">480p</option>
              <option value="1280x720" selected>720p</option>
              <option value="1920x1080">1080p</option>
            </select>
          </label>

          <label>تنعيم:
            <select id="smoothSelect">
              <option value="0.85">قوي</option>
              <option value="0.7" selected>متوسط</option>
              <option value="0.45">خفيف</option>
              <option value="0">لا تنعيم</option>
            </select>
          </label>

          <label>رسم تصحيحي:
            <select id="debugSelect">
              <option value="off">إيقاف</option>
              <option value="on" selected>تشغيل</option>
            </select>
          </label>
        </div>

        <div style="margin-top:12px" class="camera-wrap">
          <video id="cam" playsinline autoplay muted></video>
          <canvas id="debug"></canvas>
          <img id="shoeOverlay" src="https://upload.wikimedia.org/wikipedia/commons/6/6a/Sneaker_icon_transparent.png" alt="shoe overlay">
        </div>

        <div class="controls" style="margin-top:10px">
          <button id="startShoe" class="primary">تشغيل الكاميرا</button>
          <button id="stopShoe">إيقاف</button>

          <label>
            قدم:
            <select id="footSelect">
              <option value="auto">تلقائي (أقرب)</option>
              <option value="left">يسرى</option>
              <option value="right">يمنى</option>
            </select>
          </label>

          <label class="hint">تكبير/تصغير:
            <input id="scaleRange" type="range" min="0.6" max="2.2" step="0.02" value="1">
          </label>
        </div>

        <div style="margin-top:10px" class="hint">
          نصيحة: يفضل وضع الهاتف على حامل أو كتابة قِصْدَ وضعه أمام قدميك. الإضاءة الجيدة تحسّن النتائج.
        </div>
      </div>
    </section>
  </main>

  <footer>نسخة تجريبية مجانية — لتحسينات مهنية يلزم SDK تجاري أو نموذج مخصّص.</footer>

<script>
/* ========== تبويب الواجهات ========== */
const tabBtns = document.querySelectorAll('.tab-btn');
const panels = { chair: document.getElementById('panel-chair'), shoe: document.getElementById('panel-shoe') };
tabBtns.forEach(b=>{
  b.addEventListener('click', ()=>{
    tabBtns.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const t = b.dataset.tab;
    Object.values(panels).forEach(p=>p.classList.remove('active'));
    panels[t].classList.add('active');
  });
});

/* ========== تبديل كرسي ========== */
const chairMV = document.getElementById('chairMV');
const swapChair = document.getElementById('swapChair');
let chairAlt = false;
swapChair.addEventListener('click', ()=>{
  if (!chairAlt) {
    chairMV.src = "https://modelviewer.dev/shared-assets/models/ChairRed.glb";
    swapChair.textContent = "عودة";
  } else {
    chairMV.src = "https://modelviewer.dev/shared-assets/models/Chair.glb";
    swapChair.textContent = "تبديل نموذج";
  }
  chairAlt = !chairAlt;
});

/* ========== Shoe Try-On (تحسين الكاميرا و smoothing) ========== */
const videoEl = document.getElementById('cam');
const canvasEl = document.getElementById('debug');
const ctx = canvasEl.getContext('2d');
const shoeImg = document.getElementById('shoeOverlay');
const startBtn = document.getElementById('startShoe');
const stopBtn = document.getElementById('stopShoe');
const cameraSelect = document.getElementById('cameraSelect');
const resSelect = document.getElementById('resSelect');
const smoothSelect = document.getElementById('smoothSelect');
const debugSelect = document.getElementById('debugSelect');
const footSelect = document.getElementById('footSelect');
const scaleRange = document.getElementById('scaleRange');
const secureWarn = document.getElementById('secureWarn');

let localStream = null;
let running = false;
let pose = null;
let rafId = null;

/* ===== devicePixel scaling ===== */
function setCanvasSizeToVideo() {
  const rect = videoEl.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvasEl.style.width = rect.width + 'px';
  canvasEl.style.height = rect.height + 'px';
  canvasEl.width = Math.round(rect.width * dpr);
  canvasEl.height = Math.round(rect.height * dpr);
  // when drawing use ctx.scale(dpr,dpr) per frame (or reset)
}

/* ===== Low-pass smoothing utility ===== */
class LowPass {
  constructor(alpha=0.7){
    this.alpha = alpha; // 0..1 higher = faster response, lower = smoother
    this.value = null;
  }
  update(newVal){
    if (this.value === null) {
      this.value = newVal;
      return this.value;
    }
    // support both scalar and {x,y} objects
    if (typeof newVal === 'number') {
      this.value = this.alpha * newVal + (1 - this.alpha) * this.value;
    } else if (newVal && typeof newVal === 'object') {
      for (const k in newVal) {
        if (Object.prototype.hasOwnProperty.call(newVal,k)) {
          if (this.value[k] === undefined) this.value[k] = newVal[k];
          else this.value[k] = this.alpha * newVal[k] + (1 - this.alpha) * this.value[k];
        }
      }
    }
    return this.value;
  }
}

/* ===== helpers: pixel conversion (mirror video) ===== */
function toPixel(xNorm, yNorm, w, h) {
  // video is mirrored horizontally
  const x = (1 - xNorm) * w;
  const y = yNorm * h;
  return {x, y};
}

/* ===== compute foot geometry and placement ===== */
/* BlazePose landmarks indexes used:
   left_ankle=27, right_ankle=28, left_heel=29, right_heel=30, left_foot_index=31, right_foot_index=32
*/
function getFootPoints(landmarks, which='auto') {
  if (!landmarks || landmarks.length < 33) return null;
  const L = {ankle:landmarks[27], heel:landmarks[29], toe:landmarks[31]};
  const R = {ankle:landmarks[28], heel:landmarks[30], toe:landmarks[32]};
  function score(p){
    // higher if closer to center and visible
    const dx = p.ankle.x - 0.5, dy = p.ankle.y - 0.5;
    const dist = Math.hypot(dx,dy);
    const vis = (p.ankle.visibility||0) + (p.toe.visibility||0);
    return (1 - dist) + vis;
  }
  if (which === 'left') return L;
  if (which === 'right') return R;
  return score(L) >= score(R) ? L : R;
}

/* ===== placement smoothing state ===== */
const posFilter = new LowPass(0.7);
const angleFilter = new LowPass(0.7);
const scaleFilter = new LowPass(0.7);

/* angle smoothing helper (deg) */
function smoothAngle(prev, nextAlpha, newAngle){
  if (prev==null) return newAngle;
  // normalize difference to [-180,180]
  let diff = (newAngle - prev + 540) % 360 - 180;
  return prev + nextAlpha * diff;
}

/* ===== place shoe overlay on canvas/video ===== */
function placeShoeOnScreen(landmarks, manualScale=1, debug=false){
  if (!landmarks) {
    shoeImg.style.display = 'none';
    return;
  }
  const which = footSelect.value;
  const foot = getFootPoints(landmarks, which);
  if (!foot || !foot.ankle || !foot.toe || !foot.heel) {
    shoeImg.style.display = 'none';
    return;
  }

  const rect = videoEl.getBoundingClientRect();
  if (rect.width === 0 || rect.height === 0) return;

  // compute normalized center between ankle and toe
  const cx = (foot.ankle.x + foot.toe.x) / 2;
  const cy = (foot.ankle.y + foot.toe.y) / 2;

  // angle (radians) from ankle->toe
  const dx = foot.toe.x - foot.ankle.x;
  const dy = foot.toe.y - foot.ankle.y;
  const angleRad = Math.atan2(dy, dx);
  let angleDeg = -angleRad * 180 / Math.PI; // invert to match mirrored video

  // footprint size (normalized) use distance heel-to-toe as primary measure
  const footLen = Math.hypot(foot.toe.x - foot.heel.x, foot.toe.y - foot.heel.y); // normalized
  // convert to pixels based on rect width
  const basePx = footLen * rect.width;
  // width & height baseline multipliers (tweak if needed)
  const w = Math.max(40, basePx * 2.0) * manualScale;
  const h = Math.max(20, basePx * 0.9) * manualScale;

  // convert center to pixel coords (mirror aware)
  const p = toPixel(cx, cy, rect.width, rect.height);
  let target = {x: p.x, y: p.y + h * 0.08, angle: angleDeg, w, h};

  // smoothing: update filters
  const alpha = parseFloat(smoothSelect.value);
  posFilter.alpha = alpha;
  angleFilter.alpha = alpha;
  scaleFilter.alpha = alpha;

  const sPos = posFilter.update({x: target.x, y: target.y});
  // angle smoothing: use smoother step
  const prevAngle = angleFilter.value ? (angleFilter.value.a||0) : null;
  const smoothA = alpha;
  const newAng = prevAngle === null ? target.angle : smoothAngle(prevAngle, smoothA, target.angle);
  angleFilter.update({a:newAng});
  const sAngle = angleFilter.value.a;

  const sScaleObj = scaleFilter.update({w: target.w, h: target.h});
  const sw = sScaleObj.w, sh = sScaleObj.h;

  // position shoeImg (note: shoeImg is in DOM coordinates, not DPR-scaled canvas)
  shoeImg.style.display = 'block';
  shoeImg.style.width = `${sw}px`;
  shoeImg.style.height = `${sh}px`;
  // translate (use transform translate and rotate)
  // we want center at sPos
  const left = sPos.x - sw/2;
  const top = sPos.y - sh/2;
  shoeImg.style.transform = `translate(${left}px, ${top}px) rotate(${sAngle}deg)`;

  // debug drawing on canvas if requested
  if (debug) {
    const dpr = window.devicePixelRatio || 1;
    // clear canvas using dpr-aware size
    ctx.save();
    ctx.scale(dpr,dpr);
    ctx.clearRect(0,0, canvasEl.width/dpr, canvasEl.height/dpr);

    // draw ankle, heel, toe
    const pAnkle = toPixel(foot.ankle.x, foot.ankle.y, rect.width, rect.height);
    const pToe = toPixel(foot.toe.x, foot.toe.y, rect.width, rect.height);
    const pHeel = toPixel(foot.heel.x, foot.heel.y, rect.width, rect.height);

    // foot line
    ctx.strokeStyle = 'rgba(45,212,191,0.95)'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(pAnkle.x, pAnkle.y); ctx.lineTo(pToe.x, pToe.y); ctx.stroke();

    // markers
    ctx.fillStyle = 'rgba(125,211,252,0.95)';
    ctx.beginPath(); ctx.arc(pAnkle.x, pAnkle.y, 6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(pToe.x, pToe.y, 6,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(pHeel.x, pHeel.y, 6,0,Math.PI*2); ctx.fill();

    // bounding box of shoe
    ctx.strokeStyle = 'rgba(255,200,100,0.9)'; ctx.lineWidth=2;
    ctx.beginPath();
    ctx.rect(left, top, sw, sh);
    ctx.stroke();

    ctx.restore();
  } else {
    // clear canvas
    const dpr = window.devicePixelRatio || 1;
    ctx.save(); ctx.scale(dpr,dpr);
    ctx.clearRect(0,0, canvasEl.width/dpr, canvasEl.height/dpr); ctx.restore();
  }
}

/* ===== init MediaPipe Pose (single instance) ===== */
async function initPoseIfNeeded() {
  if (pose) return pose;
  pose = new Pose.Pose({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}` });
  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.55,
    minTrackingConfidence: 0.5,
  });
  pose.onResults((res)=>{
    const debugOn = debugSelect.value === 'on';
    if (res && res.poseLandmarks) {
      placeShoeOnScreen(res.poseLandmarks, parseFloat(scaleRange.value), debugOn);
    } else {
      shoeImg.style.display = 'none';
      // clear canvas
      const dpr = window.devicePixelRatio || 1;
      ctx.save(); ctx.scale(dpr,dpr);
      ctx.clearRect(0,0, canvasEl.width/dpr, canvasEl.height/dpr); ctx.restore();
    }
  });
  return pose;
}

/* ===== start / stop camera (manual loop for control) ===== */
async function startCamera() {
  try {
    // check secure origin
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      secureWarn.style.display = 'block';
    } else secureWarn.style.display = 'none';

    await initPoseIfNeeded();
    // build constraints
    const facing = cameraSelect.value; // 'environment' or 'user'
    const res = resSelect.value.split('x');
    const width = parseInt(res[0],10) || 1280;
    const height = parseInt(res[1],10) || 720;

    const constraints = {
      audio: false,
      video: {
        width: {ideal: width},
        height: {ideal: height},
        facingMode: { ideal: facing }
      }
    };

    // get user media
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = localStream;
    // await play
    await videoEl.play();

    setCanvasSizeToVideo();

    running = true;
    // loop: feed frames to pose
    async function frameLoop(){
      if (!running) return;
      try {
        await pose.send({image: videoEl});
      } catch(e){
        // ignore occasional frame errors
        console.warn('pose frame error', e);
      }
      rafId = requestAnimationFrame(frameLoop);
    }
    frameLoop();
  } catch (err) {
    console.error('فشل تشغيل الكاميرا', err);
    alert('فشل تشغيل الكاميرا: ' + (err.message || err));
  }
}

async function stopCamera() {
  running = false;
  if (rafId) cancelAnimationFrame(rafId);
  if (localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }
  videoEl.pause();
  videoEl.srcObject = null;
  shoeImg.style.display = 'none';
  // clear canvas
  const dpr = window.devicePixelRatio || 1;
  ctx.save(); ctx.scale(dpr,dpr); ctx.clearRect(0,0, canvasEl.width/dpr, canvasEl.height/dpr); ctx.restore();
}

startBtn.addEventListener('click', startCamera);
stopBtn.addEventListener('click', stopCamera);

/* resize handler */
window.addEventListener('resize', ()=>{
  setCanvasSizeToVideo();
});

/* initial canvas sizing (in case video not loaded yet) */
setTimeout(setCanvasSizeToVideo, 300);

/* keyboard+visibility safety */
document.addEventListener('visibilitychange', ()=>{
  if (document.hidden) {
    // pause to save resources
    if (running) {
      // don't fully stop; just pause processing by setting running false
      // we choose to stop to release camera
      stopCamera();
    }
  }
});
</script>
</body>
</html>
